{
  "hash": "8c9c90a98de6ce1d102058c2d937a1fd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Seagrass mapping in two mudflats in the Auray River\nsubtitle: About a rapid evolution of seagrasses\nauthor:\n  - name: Simon Oiry\n    email: oirysimon@gmail.com\n    orcid: 0000-0001-7161-5246\n    affiliations: \n        - id: ISOMER\n          name: Nantes Université, UR 2160, F-44000 Nantes, France\n          department: Institut des Substances et Organismes de la Mer, ISOMer\n          address: 2 chemin de la houssinière\n          city: Nantes\n          state: France\n          postal-code: 44300\n    attributes:\n        corresponding: true\n  - name: Bede Ffinian Rowe Davies\n    email: bedeffinian@gmail.com\n    orcid: 0000-0001-6462-4347\n    affiliations: \n        - id: ISOMER\n          name: Nantes Université, UR 2160, F-44000 Nantes, France\n          department: Institut des Substances et Organismes de la Mer, ISOMer\n          address: 2 chemin de la houssinière\n          city: Nantes\n          state: France\n          postal-code: 44300\n    attributes:\n        corresponding: true\nabstract: |\n  Maps of seagrass in two sites in the Auray River. These two sites were studied by Maxime Daviray during his PhD. Seagrass appeared very quickly during his PhD. This work aims to describe this rapid evolution of seagrasses.\nkeywords: \n  - Remote Sensing\n  - Sentinel-2\n  - Seagrass\ndate: last-modified\nbibliography: library.bib\nnumber-sections: true\nnotebook-links: false\neditor_options: \n  chunk_output_type: console\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --\nv dplyr     1.1.4     v readr     2.1.5\nv forcats   1.0.0     v stringr   1.5.1\nv ggplot2   3.5.1     v tibble    3.2.1\nv lubridate 1.9.3     v tidyr     1.3.1\nv purrr     1.0.2     \n-- Conflicts ------------------------------------------ tidyverse_conflicts() --\nx dplyr::filter() masks stats::filter()\nx dplyr::lag()    masks stats::lag()\ni Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(tidyterra)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttachement du package : 'tidyterra'\n\nL'objet suivant est masqué depuis 'package:stats':\n\n    filter\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(terra)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nterra 1.7.78\n\nAttachement du package : 'terra'\n\nL'objet suivant est masqué depuis 'package:tidyr':\n\n    extract\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(patchwork)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttachement du package : 'patchwork'\n\nL'objet suivant est masqué depuis 'package:terra':\n\n    area\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nlibrary(png)\nlibrary(gridExtra)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttachement du package : 'gridExtra'\n\nL'objet suivant est masqué depuis 'package:dplyr':\n\n    combine\n```\n\n\n:::\n:::\n\n\n\n\n\nThe data and scripts used for this work can be found [here](https://github.com/SigOiry/Seagrass_maps_Maxime).\n\n# Materials & Methods\n\n## Seagrass mapping using Sentinel-2\n\nTo map the seagrass extent over time, the Sentinel-2 constellation has been used. Level-2 images, which are already orthorectified and atmospherically corrected, have been downloaded using the Copernicus Platform [@Copernicus_Sentinel]. One low tide, cloud-free image per year, nearest to the period of the annual maximum seagrass biomass at this latitude has been used. A total of 8 images have been used (@tbl-tide-data).\n\n| Acquisition Date (UTC) | Low Tide Time (UTC) | Time Difference with Low tide |\n|:---------------------:|:------------------:|:---------------------------:|\n|    2016-11-03 11:12    |       12 : 08       |          \\+ 00 : 56           |\n|    2017-10-04 11:08    |       09 : 09       |          \\- 01 : 59           |\n|    2018-09-29 11:08    |       12 : 43       |          \\+ 01 : 35           |\n|    2019-09-14 11:06    |       10 : 28       |          \\+ 00 : 38           |\n|    2020-08-04 11:06    |       10 : 45       |          \\+ 00 : 21           |\n|    2021-10-08 11:09    |       11 : 18       |          \\- 00 : 09           |\n|    2022-08-29 11:06    |       11 : 27       |          \\- 00 : 21           |\n|    2023-09-03 11:06    |       12 : 28       |          \\- 01 : 22           |\n\n: Acquisition dates of Sentinel-2 images used to map seagrass in the Auray River mudflats. Tide times were retrieved from the SHOM and correspond to the tides at the Locmariaquer tide gauge, situated approximately 2 km from the study sites. {#tbl-tide-data}\n\nThe *Intertidal Classification of Europe: Categorising Reflectance of Emerged Areas of Marine vegetation with Sentinel-2* model has been applied to each Sentinel-2 image (ICE CREAMS, @Davies2024). It is a neural network classifier designed to identify and discriminate intertidal vegetation in Europe. Pixels of the Magnoliopsida class (seagrasses) have been isolated, and the Normalized Difference Vegetation Index (NDVI, @rouse1974monitoring), a commonly used remote sensing biomass proxy for vegetation, has been employed. The equation of @zoffoli2020sentinel have been used to transform NDVI values into Seagrass Percent Cover ([@eq-std]). Only pixels with SPC values above 20%, corresponding to high biomass pixel have been considered in order to avoid confusion with other class of vegetation. \n\n$$\nSPC = 172.06 \\times NDVI - 22.18\n$$ {#eq-std}\n\nMaps and analysis have then been performed using the *Terra* package of R, in a *Tidyverse* workflow [@hijmans2023terra ; @wickham2017easily]. \n\n# Results\n\n## Evolution of the spatial distribution of seagrasses over time\n\nThe time series of the seagrass percent cover between 2016 and 2023 shows an overall increase in meadow extent at both sites(@fig-Maps). From 2019 onwards, the meadows became denser at Fort Espagnol, particularly in the northern part of the mudflat. At Kerouarc'h, the meadow was limited to small, sparse patches between 2016 and 2019. However, from 2021 onward, the seagrass meadow experienced a rapid expansion, covering almost the entire mudflat.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nrgb_list <- list.files(\"Data/RGB/\", pattern = \".tif\", recursive = TRUE, full.names = TRUE) %>%\n  as_tibble() %>% \n  rename(path_rgb = \"value\") %>%  \n  mutate(name = gsub(\".*/\",\"\",path_rgb),                 # Extract the filename\n         year = substr(name,1,4)) %>% \n  dplyr::select(-name)\n\nimg_list <- list.files(\"Data/ICECREAMS/\", pattern = \".tif\", recursive = TRUE, full.names = TRUE) %>% \n  as_tibble() %>% \n  rename(path_pred = \"value\") %>% \n  mutate(name = gsub(\".*/\",\"\",path_pred),                 # Extract the filename\n         year = substr(name,12,15),                  # Extract the year from the filename\n         date = as.POSIXct(substr(name,12,19), format = \"%Y%m%d\")) %>% \n  left_join(rgb_list, by = \"year\")\n\n\n\n# Extract and format the date\nmask <- \"Data/mask/Intertidal_mask_Auray.shp\" %>% \n  vect()\n\nfor (i in 1:nrow(img_list)) {\n  \n  pred <- img_list$path_pred[i] %>% \n    rast(lyrs = 5) %>% \n    mask(mask) %>% \n    as.data.frame(xy=T) %>% \n    mutate(SPC20Unknown = case_when(SPC20Unknown < 30 ~ NA,\n                     T ~ SPC20Unknown))\n    \n  rgb <- img_list$path_rgb[i] %>% \n    rast()\n\n    for(site_i in 1:length(unique(mask$Site_Name))){\n      \n      \n      site <- unique(mask$Site_Name)[site_i]\n    \n      # Extract the mask for the current site\n      ext <- mask[which(mask$Site_Name == site)] %>% \n        ext()\n      \n      resize_x <- (as.numeric(ext[2])- as.numeric(ext[1]))*0.2\n      resize_y <- (as.numeric(ext[4])- as.numeric(ext[3]))*0.15\n\n      text_position_x <- as.numeric(ext[1] + ((as.numeric(ext[2])- as.numeric(ext[1]))*0.1))\n      text_position_y <- as.numeric(ext[3] - ((as.numeric(ext[4])- as.numeric(ext[3]))*0.12))\n\n      \n      plot <- ggplot()+\n        geom_spatraster_rgb(data = rgb,\n                            max_col_value = 0.8)+\n        coord_sf(xlim = c(ext[1]-resize_x, ext[2]+resize_x),\n                ylim = c(ext[3]-resize_y, ext[4]+resize_y)) +\n        # geom_text(aes(x = text_position_x, y = text_position_y, label = img_list$year[i]), color = \"white\" , size = 5)+\n        scale_fill_viridis_c(na.value = \"transparent\")+\n        theme(axis.text = element_blank(),\n              axis.title = element_blank(),\n              axis.ticks = element_blank(),\n              plot.margin = margin(0, 0, 0, 0, \"mm\"))\n    \n      if(site_i == 1){\n        a <- plot +\n          geom_tile(data = pred, aes(x = x, y = y, fill = SPC20Unknown), show.legend = F) +  # Use a continuous color scale and make NA values transparent\n\n          geom_text(aes(x = 503360, y = 5274145, label = \"Fort Espagnol\" ), color = \"white\" , size = 7) +\n          geom_text(aes(x = 503301.7, y = 5273133, label = img_list$year[i]), color = \"white\" , size = 7)\n        \n        if(img_list$year[i]==\"2023\"){\n          a <- a +\n            geom_rect(aes(xmin = 503436, xmax = 503738, ymin = 5273032, ymax = 5273120), fill = \"white\", alpha = 0.4)+\n            ggspatial::annotation_scale(location = \"br\",\n                                  text_cex=2,\n                                  bar_cols = c(\"white\", \"black\"))\n        }\n  \n      }else{\n        b = plot +\n          geom_text(aes(x = 502650, y = 5271835, label = \"Kerouarc'h\" ), color = \"white\" , size = 7)\n        \n        if(img_list$year[i]==\"2023\"){\n          \n          b <- b + geom_tile(data = pred, aes(x = x, y = y, fill = SPC20Unknown))  +\n                labs(fill = \"SPC (%)\")+\n                geom_rect(aes(xmin = 503282, xmax = 504282, ymin = 5269000, ymax = 5269250), fill = \"white\", alpha = 0.4)+\n    \n                \n                theme(legend.position = c(.9,.85),\n                      legend.background = element_rect(fill=scales::alpha('white', 0.4)),\n                      legend.text = element_text(size = 15),\n                      legend.title = element_text(size = 18,margin = margin(b = 15)),\n                      legend.key.size = unit(0.7,\"cm\")\n                      )+\n                ggspatial::annotation_scale(location = \"br\",\n                                    text_cex=2,\n                                    bar_cols = c(\"white\", \"black\"))\n\n        }else{\n          b = b + geom_tile(data = pred, aes(x = x, y = y, fill = SPC20Unknown), show.legend = F)  # Use a continuous color scale and make NA values transparent\n\n        }\n      }\n      \n      \n    }\n  \n  patchwork <- a+b\n  ggsave(paste0(\"Output/Figs/maps/\",img_list$year[i],\"_maps.png\"),patchwork, width = 832*3, height = 759*3, units = \"px\" )\n}\n\n\nread_png_as_ggplot <- function(file_path) {\n  img <- readPNG(file_path)\n  img_grob <- grid::rasterGrob(img, interpolate = TRUE)\n   return(ggplot() +\n    annotation_custom(img_grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +\n    theme_void())\n}\n\npng_files <- list.files(path = \"Output/Figs/maps\", pattern = \"*.png\", full.names = TRUE)\n\n# Create a list of ggplot objects\nplot_list <- lapply(png_files, read_png_as_ggplot)\n\n# Combine plots into one\ncombined_plot <- do.call(grid.arrange, c(plot_list, ncol = 4))  # Change ncol to adjust the number of columns\n\nggsave(\"Output/Figs/Figure1.png\",combined_plot, width = 2620*2, height = (2620*2)/2.3, units = \"px\")\nggsave(\"Manuscript/Figs/Figure1.png\", a, width = 1000 * 4, height = (500 * 4), units = \"px\")\n```\n:::\n\n::: {#cell-fig-Maps .cell}\n\n```{.r .cell-code .hidden}\nknitr::include_graphics(\"Figs/Figure1.png\")\n```\n\n::: {.cell-output-display}\n![Time Serie of the Seagrass Percent cover between 2016 and 2023 in Fort Espagnol and Kerouarc'h, two sites of the Auray river.](Figs/Figure1.png){#fig-Maps width=100%}\n:::\n:::\n\n\n\n\n\n\n## Evolution of the extent and density of the meadow over time\n\nThe maximum total extent of seagrass was reached in 2021 at Fort Espagnol and in 2022 at Kerouarc'h. Overall, during this period, the extent of the meadow at Fort Espagnol increased by approximately 50% and by about 90% at Kerouarc'h (@fig-Extent A). The density of the meadow remained relatively constant between 2016 and 2020 at both sites before increasing to 54% of the median SPC in 2023 at Fort Espagnol and 63% in 2022 at Kerouarc'h (@fig-Extent B). The year 2020 is an exception to these trends due to green algae covering the meadow in August, which impeded the detection of the underlying seagrass with remote sensing techniques.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# List all .tif files in the \"Data/ICECREAMS/\" directory, including subdirectories, and convert to a tibble\nimg_list <- list.files(\"Data/ICECREAMS/\", pattern = \".tif\", recursive = TRUE, full.names = TRUE) %>% \n  as_tibble() %>% \n  rename(path = \"value\") %>% \n  mutate(\n    name = gsub(\".*/\",\"\", path),                 # Extract the filename\n    year = substr(name, 12, 15),                 # Extract the year from the filename\n    date = as.POSIXct(substr(name, 12, 19), format = \"%Y%m%d\")  # Extract and format the date\n  )\n\n# Load the intertidal mask shapefile\nmask <- \"Data/mask/Intertidal_mask_Auray.shp\" %>% \n  vect()\n\n# Select the mask for a specific site\nmask_site <- mask[which(mask$Site_Name == unique(mask$Site_Name)[site_i])]\n\n# Loop through each image and each site to process the data\nfor (img_i in 1:nrow(img_list)) {\n  for (site_i in 1:length(unique(mask$Site_Name))) {\n    \n    # Extract the mask for the current site\n    mask_site <- mask[which(mask$Site_Name == unique(mask$Site_Name)[site_i])]\n    \n    # Process the current image\n    df <- img_list %>% \n      slice(img_i) %>% \n      pull(path) %>% \n      rast() %>% \n      crop(mask_site) %>%                    # Crop the image to the site mask\n      as.data.frame(xy = TRUE) %>%           # Convert the raster to a data frame\n      mutate(\n        site = unique(mask$Site_Name)[site_i],  # Add site information\n        date = img_list %>% \n          slice(img_i) %>% \n          pull(date),                   # Add date information\n        year = img_list %>% \n          slice(img_i) %>% \n          pull(year) %>% \n          as.numeric()                 # Add year information\n      ) %>%               \n      dplyr::filter(\n        out_class == 4 & SPC20Unknown > 20   # Filter the data for a specific class\n      ) %>%        \n      as_tibble()\n    \n    # Combine the data frames\n    if (img_i == 1 & site_i == 1) {\n      output <- df\n    } else {\n      output <- rbind(output, df)\n    }\n    \n  }\n  rm(df)\n  rm(mask_site)\n}\n\n# Retrieve the area of each site\narea <- mask %>% \n  sf::st_as_sf() %>% \n  sf::st_area() %>% \n  as.numeric() %>% \n  as.data.frame() %>% \n  rename(area = \".\") %>% \n  mutate(site = unique(output$site))\n\n# Define color scheme for sites\ncols <- c(\"Kerouarc'h\" = \"#335145\", \"Fort Espagnol\" = \"#a9d8b8\")\n\n# Prepare area data again (seems redundant, might be a mistake)\narea <- mask %>% \n  sf::st_as_sf() %>% \n  sf::st_area() %>% \n  as.numeric() %>% \n  as.data.frame() %>% \n  rename(area = \".\") %>% \n  mutate(site = unique(output$site))\n\n# Create the plot for relative seagrass extent\nplot <- output %>% \n  group_by(year, site) %>% \n  reframe(seagrass_area = n() * 100 * (10^-6)) %>%\n  ungroup() %>% \n  group_by(site) %>% \n  mutate(relative_surface = seagrass_area / max(seagrass_area)) %>% \n  left_join(area, by = \"site\") %>%\n  ggplot() +\n  geom_histogram(aes(x = year, y = relative_surface, fill = site), stat = \"identity\", position = position_dodge(), alpha = 0.8, color = \"black\", linewidth = 0.5) +\n  annotate(\"text\", x = 2015.5, y = 1, label = \"A\", size = 10) +\n  ylab(\"Relative extent\") +\n  xlab(\"Year\") +\n  scale_fill_manual(values = cols) +\n  labs(fill = \"Sites:\") + \n  theme_bw() +\n  theme(\n    axis.title = element_text(size = 20),\n    axis.text = element_text(size = 15),\n    legend.text = element_text(size = 15),\n    legend.title = element_text(size = 17),\n    legend.position = \"top\"\n  )\n\n# Boxplot of SPC\nplot_SPC <- output %>% \n  ggplot() + \n  geom_boxplot(aes(x = year, y = SPC20Unknown, fill = site, group = interaction(site, year)), outlier.alpha = 0.1, alpha = 0.8, color = \"black\", linewidth = 0.5, show.legend = FALSE) +\n  annotate(\"text\", x = 2015.5, y = 100, label = \"B\", size = 10) +\n  ylab(\"Seagrass Cover (%)\") +\n  xlab(\"Year\") +\n  ylim(20, 100) +\n  scale_fill_manual(values = cols) +\n  labs(fill = \"Sites:\") + \n  theme_bw() +\n  scale_y_continuous(position = \"right\") +\n  theme(\n    axis.title = element_text(size = 20),\n    axis.text = element_text(size = 15),\n    legend.text = element_text(size = 15),\n    legend.title = element_text(size = 17),\n    legend.position = \"top\"\n  )\n\nstat_boxplot <- output %>% \n  group_by(site,year) %>% \n  reframe(med = median(SPC20Unknown))\n\n# Combine the two plots and save the figure\na <- plot + plot_SPC\nggsave(\"Output/Figs/Figure2.png\", a, width = 1000 * 4, height = (500 * 4), units = \"px\")\nggsave(\"Manuscript/Figs/Figure2.png\", a, width = 1000 * 4, height = (500 * 4), units = \"px\")\n```\n:::\n\n::: {#cell-fig-Extent .cell}\n\n```{.r .cell-code .hidden}\nknitr::include_graphics(\"Figs/Figure2.png\")\n```\n\n::: {.cell-output-display}\n![Descritpion of the evolution of seagrass over time. A - Relative sesgrass extent of each site. 1 means maximum extent of the time serie for the site. B - Boxplot of the density of seagrass for each site at each date. The lower and upper hinges correspond to the first and third quartiles (the 25th and 75th percentiles). Whiskers are to 1.5 * IQR (Inter-Quartile Range) from the hinge.](Figs/Figure2.png){#fig-Extent width=100%}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}